import-Module ActiveDirectory
# Set the number of days to keep profiles
$daysToKeep = 120

# Get the current date
$currentDate = Get-Date

# Calculate the date threshold for profile deletion
$thresholdDate = $currentDate.AddDays(-$daysToKeep)

# Get a list of user profiles that haven't logged in for over 120 days
$profilesToDelete = Get-WmiObject -Query "SELECT * FROM Win32_UserProfile" | Where-Object { $_.Special -eq $false -and $_.LastUseTime -lt $thresholdDate }

# Iterate through the profiles and delete them
foreach ($profile in $profilesToDelete) {
    $profileSID = $profile.SID
    $profilePath = $profile.LocalPath

    # Unload the user profile to release any locks
    if ($profile.Loaded -eq $true) {
        Invoke-Command -ScriptBlock { Get-WmiObject -Query "SELECT * FROM Win32_UserProfile WHERE SID = '$using:profileSID'" | ForEach-Object { $_.Unload() } }
    }

    # Delete the user profile folder
    Remove-Item -Path $profilePath -Force -Recurse

    # Remove the profile from the user profiles list
    Remove-WmiObject -InputObject $profile
}

# Output the deleted profiles
$profilesToDelete | Select-Object LocalPath, LastUseTime | Format-Table -AutoSize
