# Set the number of days within which a certificate is considered to be expiring
$expiryThresholdDays = 365

# Get a list of all servers in the Active Directory environment
$servers = Get-ADComputer -Filter {OperatingSystem -Like "*Server*"} | Select-Object -ExpandProperty Name

# Create an array to hold the certificate information
$certInfo = @()

# Loop through each server
foreach ($server in $servers) {
    Write-Host "Checking certificates on $server..."

    # Connect to the server using PowerShell remoting
    $session = New-PSSession -ComputerName $server

    # Get the certificates from the LocalMachine\My certificate store on the remote server
    $certs = Invoke-Command -Session $session -ScriptBlock { Get-ChildItem Cert:\LocalMachine\My }

    # Loop through each certificate
    foreach ($cert in $certs) {
        # Check if the certificate is a server certificate and not a root or intermediate certificate
        if ($cert.EnhancedKeyUsageList.FriendlyName -contains "Server Authentication" -and $cert.Issuer -notmatch "^(Root|Intermediate)CA") {
            # Get the expiration date of the certificate
            $expiryDate = $cert.NotAfter

            # Calculate the number of days until the certificate expires
            $daysUntilExpiry = ($expiryDate - (Get-Date)).Days

            # Check if the certificate is expiring within the next 365 days
            if ($daysUntilExpiry -le $expiryThresholdDays) {
                # Add the certificate information to the array
                $certInfo += [PSCustomObject]@{
                    Server = $server
                    Subject = $cert.Subject
                    ExpiryDate = $expiryDate
                    DaysUntilExpiry = $daysUntilExpiry
                }
            }
        }
    }

    # Disconnect from the server
    Remove-PSSession $session
}

# Save the certificate information to an Excel file on the desktop
$filePath = "$([Environment]::GetFolderPath('Desktop'))\CertFinder.csv"
$certInfo | ConvertTo-Csv -NoTypeInformation | Out-File $filePath

Write-Host "Certificate information saved to $filePath"
